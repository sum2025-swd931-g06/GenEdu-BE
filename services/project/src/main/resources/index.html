<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streaming Slides (AI Word-by-Word)</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .slide { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-left: 5px solid #007acc; background: #f9f9f9; }
        .slide h2 { margin: 0; }
        .slide-content { white-space: pre-wrap; margin-top: 5px; }
    </style>
</head>
<body>
<h1>Live Slide Streaming</h1>
<div id="output"></div>

<script>
    const token = "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJPTE15ZmFUYnZxU0J4NGpmRkdXbHRrRjlDT2FaYXh6R0NHbnZzVmptQTBNIn0.eyJleHAiOjE3NTA4NzM4MDksImlhdCI6MTc1MDg3MzUwOSwianRpIjoiYTA0YTFiM2ItMjU4OS00NDdkLTlkOGUtNjFlYzAzYjhmMDU1IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo5MDk5L3JlYWxtcy9HZW5FZHUiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiNDk0ODcwYTEtMDA4YS00MTAyLWEyNjMtZmQ1OTg3MzU4MGE0IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiZ2VuZWR1LWJlIiwic2Vzc2lvbl9zdGF0ZSI6ImY2ODUwYTZhLTk4NTMtNGQ5Yy1hOTRjLTc4NGI5MTBmNDNiMiIsImFjciI6IjEiLCJhbGxvd2VkLW9yaWdpbnMiOlsiaHR0cDovL2xvY2FsaG9zdDo4MDkwIiwiaHR0cDovL2xvY2FsaG9zdDo4MjIyIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJnZW5lZHUtdXNlciIsImRlZmF1bHQtcm9sZXMtZ2VuZWR1Iiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6ImY2ODUwYTZhLTk4NTMtNGQ5Yy1hOTRjLTc4NGI5MTBmNDNiMiIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwicm9sZXMiOlsiZ2VuZWR1LXVzZXIiLCJkZWZhdWx0LXJvbGVzLWdlbmVkdSIsIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXSwibmFtZSI6InVzZXIxIHVzZXIxIiwicHJlZmVycmVkX3VzZXJuYW1lIjoidXNlcjEiLCJnaXZlbl9uYW1lIjoidXNlcjEiLCJmYW1pbHlfbmFtZSI6InVzZXIxIiwiZW1haWwiOiJ1c2VyMUBnbWFpbC5jb20ifQ.jX9QG88cE2FFUJ_BY4HCfnxY2EKNVe-PzsMH8S7oroCB1W6aecJWnYndMkslzQF3Rab2Hy-z6_K9Qyr9T5Yedooi00N2W1g6GLSCNGyKXC8uT6Y_-Tgy75q-AaaD-dc5889NL_ztyuoFbzhEiLzZKiq9nJEB_-fRBhjvWARz6LWlRQuAVrg-BEUpRVwZbAGbR-zejdKhwJTTjxfME23MdGfdQ9VxZL5heCTLavCSeXblFj_Ov9x2hPpTVs0DWebFTVWGOEIfxJP6zT64_XUpgO04_LZQMKmOY-6dBJ4HrFGeBzaRuF1VRZfa912AL-FwqLM4j8SCzqe0PyIiWKol_Q";
    const output = document.getElementById("output");

    const slideMap = {}; // slideId -> { type, words: [] }

    function appendWordToSlide(slideId, slideType, word) {
        if (!slideMap[slideId]) {
            slideMap[slideId] = { type: slideType, words: [] };
        }
        if (word && word.trim() !== "") {
            slideMap[slideId].words.push(word);
            renderSlides();
        }
    }

    function renderSlides() {
        output.innerHTML = '';
        const sortedIds = Object.keys(slideMap).sort((a, b) => parseInt(a) - parseInt(b));
        for (const id of sortedIds) {
            const slide = slideMap[id];
            const div = document.createElement("div");
            div.className = "slide";
            div.innerHTML = `
          <h2>Slide ${id} (${slide.type})</h2>
          <div class="slide-content">${slide.words.join(" ")}</div>
        `;
            output.appendChild(div);
        }
    }

    async function streamSlides() {
        const response = await fetch("http://localhost:8092/api/v1/projects/stream/slide-content", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Accept": "text/event-stream"
            }
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });

            const chunks = buffer.split('\n\n');
            buffer = chunks.pop(); // Keep unfinished

            for (const chunk of chunks) {
                const lines = chunk.split('\n');
                let id = null;
                let eventType = null;
                let data = '';

                for (const line of lines) {
                    if (line.startsWith('id:')) {
                        id = line.slice(3).trim();
                    } else if (line.startsWith('event:')) {
                        eventType = line.slice(6).trim();
                    } else if (line.startsWith('data:')) {
                        data += line.slice(5).trim();
                    }
                }

                if (eventType === 'slide-content' && data) {
                    try {
                        const parsed = JSON.parse(data);
                        appendWordToSlide(parsed.slideId, parsed.slideType, parsed.content);
                    } catch (err) {
                        console.error("Invalid JSON:", data, err);
                    }
                }
            }
        }
    }

    streamSlides();
</script>
</body>
</html>
